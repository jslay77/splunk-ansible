---
# Install the UF (opt splunk should already exist) 
#
#

- name: Check for existing UF repo.
  stat: path="{{ splunk_home }}/.git"
  register: st
  ignore_errors: True
  become: true


- include: install.yml
  when: st.stat.isdir is not defined

- name: Ensure SPLUNK_OS_USER is set
  lineinfile: dest="{{ splunk_home }}/etc/splunk-launch.conf" 
              state=present 
              regexp="^SPLUNK_OS_USER="
              line="SPLUNK_OS_USER={{ splunk_user }}"
  become: true
  register: osuser
  become_user: "{{ splunk_user }}"

- name: Copy web.conf for splunk UF
  template: src=web.conf dest="{{ splunk_home }}/etc/system/local/web.conf" mode=650
  become: yes
  become_user: "{{ splunk_user }}"
  register: webconf

- name: Copy deploymentclient.conf
  template: src=deploymentclient.conf dest="{{ splunk_home }}/etc/system/local/deploymentclient.conf" mode=650
  become: yes
  become_user: "{{ splunk_user }}"
  register: depconf

- name: Restart splunk 
  service: name="splunk-{{ splunk_role }}" state=restarted enabled=yes 
  become: yes
  when: (depconf.changed or webconf.changed or osuser.changed)


